<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Guaca del Taita 360 — Quest 3</title>
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin: 0; background: #000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .btn { cursor: pointer; }
  </style>
</head>
<body>
  <!-- Audio -->
  <audio id="track" preload="auto" src="media/relato.mp3" crossorigin="anonymous" playsinline></audio>

  <a-scene
    background="color: #000000"
    renderer="antialias: true; colorManagement: true; powerPreference: high-performance; physicallyCorrectLights: false; alpha: false"
    webxr="referenceSpaceType: local-floor; optionalFeatures: local-floor"
    vr-mode-ui="enabled: true">

    <a-assets timeout="60000">
      <img id="placeholder" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8Xw8AAlEBz4Z7xvQAAAAASUVORK5CYII="/>
    </a-assets>

    <!-- Cámara + cursores -->
    <a-entity id="rig" position="0 1.6 0">
      <a-entity id="cam" camera look-controls wasd-controls-enabled="false">
        <!-- ====== MENÚ 3D centrado (hijo de la cámara) ====== -->
        <a-entity id="menuRoot" position="0 0 -1.5" rotation="0 0 0" scale="1 1 1">
          <!-- Fondo -->
          <a-entity geometry="primitive: plane; width: 1.2; height: 0.62"
                    material="color: #000; opacity: 0.55; transparent: true; shader: flat"
                    position="0 0 0"></a-entity>

          <!-- Título -->
          <a-text font="kelsonsans" value="La Guaca del Taita, Nariño"
                  width="1.1" position="-0.53 0.22 0.01" color="#FFF"></a-text>

          <!-- Botones fila 1 -->
          <a-entity id="btnStart" class="clickable btn"
                    geometry="primitive: plane; width: 0.32; height: 0.12"
                    material="color: #14b8a6; opacity: 0.95; shader: flat"
                    position="-0.38 0.05 0.01">
            <a-text value="INICIAR" width="0.6" align="center" color="#00110f" position="0 0 0.01"></a-text>
          </a-entity>

          <a-entity id="btnVR" class="clickable btn"
                    geometry="primitive: plane; width: 0.32; height: 0.12"
                    material="color: #64748b; opacity: 0.95; shader: flat"
                    position="0.38 0.05 0.01">
            <a-text value="ENTRAR VR" width="0.6" align="center" color="#fff" position="0 0 0.01"></a-text>
          </a-entity>

          <!-- Botones fila 2 -->
          <a-entity id="btnPrev" class="clickable btn"
                    geometry="primitive: plane; width: 0.28; height: 0.12"
                    material="color: #334155; opacity: 0.95; shader: flat"
                    position="-0.54 -0.13 0.01">
            <a-text value="⟨⟨ Anterior" width="0.55" align="center" color="#fff" position="0 0 0.01"></a-text>
          </a-entity>

          <a-entity id="btnPlay" class="clickable btn"
                    geometry="primitive: plane; width: 0.28; height: 0.12"
                    material="color: #0ea5e9; opacity: 0.95; shader: flat"
                    position="-0.12 -0.13 0.01">
            <a-text id="playLabel" value="⏯ Play/Pause" width="0.55" align="center" color="#00111a" position="0 0 0.01"></a-text>
          </a-entity>

          <a-entity id="btnNext" class="clickable btn"
                    geometry="primitive: plane; width: 0.28; height: 0.12"
                    material="color: #334155; opacity: 0.95; shader: flat"
                    position="0.30 -0.13 0.01">
            <a-text value="Siguiente ⟩⟩" width="0.55" align="center" color="#fff" position="0 0 0.01"></a-text>
          </a-entity>

          <!-- Tiempo -->
          <a-text id="time3d" font="kelsonsans" value="00:00"
                  width="0.8" position="0.52 -0.31 0.01" align="right" color="#fff"></a-text>
        </a-entity>

        <!-- Caption bajo el menú (también hijo de la cámara) -->
        <a-text id="caption3d" font="kelsonsans"
                value="Pulsa INICIAR para comenzar"
                width="1.6" position="-0.8 -0.55 -1.5" color="#fff"></a-text>

        <!-- Cursor mouse (desktop) -->
        <a-entity id="mouseRay" cursor="rayOrigin: mouse"
                  raycaster="objects: .clickable; far: 10"></a-entity>
      </a-entity>

      <!-- Controles VR (láser) -->
      <a-entity laser-controls="hand: left"  raycaster="objects: .clickable; far: 10"></a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 10"></a-entity>
    </a-entity>

    <!-- Cielos 360 con crossfade -->
    <a-sky id="skyA" radius="20"
           material="side: back; shader: flat; src: #placeholder; transparent: true; opacity: 1"></a-sky>
    <a-sky id="skyB" radius="20"
           material="side: back; shader: flat; src: #placeholder; transparent: true; opacity: 0"></a-sky>
  </a-scene>

  <script>
    // === Cronograma (seg) ===
    const schedule = [
      { t: 0,  src: 'media/titulo.png',    caption: 'La Guaca del Taita' },
      { t: 2,  src: 'media/escena_1.png',  caption: 'En lo alto de las montañas de Sandoná, vivía un anciano taita llamado Julián...' },
      { t: 11, src: 'media/escena_2.png',  caption: 'Cada tarde, su nieta Amalia se sentaba a su lado para escuchar historias.' },
      { t: 17, src: 'media/escena_3.png',  caption: 'El taita le habló de una guaca escondida...' },
      { t: 24, src: 'media/escena_4.png',  caption: 'Amalia soñó con hallar aquella guaca. Una mañana...' },
      { t: 32, src: 'media/escena_5.png',  caption: 'Escuchó el río cantar, vio mariposas azules guiándola.' },
      { t: 37, src: 'media/escena_6.png',  caption: 'Al llegar a una cueva pequeña, encontró símbolos tallados en piedra...' },
      { t: 44, src: 'media/escena_7.png',  caption: 'Amalia comprendió que los abuelos habían guardado ahí su memoria...' },
      { t: 53, src: 'media/escena_8.png',  caption: 'Cuando volvió a casa, contó a su abuelo lo que había visto...' },
      { t: 59, src: 'media/escena_9.png',  caption: 'El taita dijo: La verdadera guaca está en nuestras raíces...' },
      { t: 70, src: 'media/escena_10.png', caption: 'Desde entonces, Amalia guardó en su corazón la certeza...' }
    ].sort((a,b)=>a.t-b.t);

    const FADE_MS = 800;

    // Refs
    const audio     = document.getElementById('track');
    const scene     = document.querySelector('a-scene');
    const skyA      = document.getElementById('skyA');
    const skyB      = document.getElementById('skyB');
    const caption3d = document.getElementById('caption3d');
    const time3d    = document.getElementById('time3d');

    const btnStart  = document.getElementById('btnStart');
    const btnVR     = document.getElementById('btnVR');
    const btnPrev   = document.getElementById('btnPrev');
    const btnPlay   = document.getElementById('btnPlay');
    const btnNext   = document.getElementById('btnNext');

    // Estado
    let usingA = true, idx = -1, rafId = null;
    let fading = false, fadeStart = 0, fadeDur = FADE_MS;
    let frontEl = null, backEl  = null;

    // Utils
    function setCaption(text){ caption3d.setAttribute('value', text || ''); }
    function fmt(t){ t=Math.max(0, t|0); const m=(t/60)|0, s=t%60; return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
    function findCueIndexAtTime(t){ let lo=0,hi=schedule.length-1,ans=-1; while(lo<=hi){ const mid=(lo+hi)>>1; if(schedule[mid].t<=t){ans=mid;lo=mid+1;} else hi=mid-1;} return ans; }

    function setOpacity(el, v){
      el.setAttribute('material','opacity',v);
      const m = el.getObject3D('mesh')?.material;
      if (m){ m.transparent = true; m.opacity = v; m.needsUpdate = true; if (m.map) m.map.needsUpdate = true; }
    }
    function forceMatUpdate(el){
      const m = el.getObject3D('mesh')?.material;
      if (m){ if (m.map) m.map.needsUpdate = true; m.needsUpdate = true; }
    }
    function setSkyTexture(el, url){
      el.setAttribute('material','transparent',true);
      el.setAttribute('material','side','back');
      el.setAttribute('material','src',`url(${url})`);
      const upd=()=>{ forceMatUpdate(el); el.removeEventListener('materialtextureloaded',upd); };
      el.addEventListener('materialtextureloaded',upd);
      setTimeout(upd,50);
    }
    function disposeTexture(el){
      const mesh = el.getObject3D('mesh');
      if (mesh && mesh.material){
        const tex = mesh.material.map;
        if (tex){ mesh.material.map = null; try{ tex.dispose(); }catch(_){ } mesh.material.needsUpdate = true; }
      }
    }

    function startFade(toIndex, instant=false){
      const cue = schedule[toIndex]; if(!cue) return;
      frontEl = usingA ? skyA : skyB;
      backEl  = usingA ? skyB : skyA;

      setSkyTexture(backEl, cue.src);
      setOpacity(backEl,0); setOpacity(frontEl,1);

      if (instant || FADE_MS<=0){
        setOpacity(backEl,1); setOpacity(frontEl,0);
        disposeTexture(frontEl);
        usingA=!usingA; idx=toIndex; setCaption(cue.caption); fading=false; return;
      }
      fadeStart=performance.now(); fadeDur=FADE_MS; fading=true; idx=toIndex; setCaption(cue.caption);
    }
    function updateFade(now){
      if(!fading) return;
      const p=Math.min(1,(now-fadeStart)/fadeDur);
      setOpacity(backEl,p); setOpacity(frontEl,1-p);
      if(p>=1){ fading=false; disposeTexture(frontEl); usingA=!usingA; }
    }
    function updateLoop(now){
      time3d.setAttribute('value', fmt(audio.currentTime|0));
      updateFade(now);
      const ct=audio.currentTime||0;
      const target = findCueIndexAtTime(ct+0.001);
      if (target!==idx && target>=0) startFade(target, Math.abs(target-idx)>1);
      rafId = requestAnimationFrame(updateLoop);
    }

    // FX botones
    function addButtonFX(el){
      el.addEventListener('mouseenter', ()=> el.setAttribute('scale','1.05 1.05 1'));
      el.addEventListener('mouseleave', ()=> el.setAttribute('scale','1 1 1'));
      el.addEventListener('mousedown',  ()=> el.setAttribute('scale','0.97 0.97 1'));
      el.addEventListener('mouseup',    ()=> el.setAttribute('scale','1.02 1.02 1'));
      el.classList.add('clickable');
    }
    [btnStart, btnVR, btnPrev, btnPlay, btnNext].forEach(addButtonFX);

    // Botones
    btnStart.addEventListener('click', async ()=>{
      if(schedule.length){
        setSkyTexture(skyA,schedule[0].src);
        setOpacity(skyA,1); setOpacity(skyB,0);
        usingA=true; idx=0; setCaption(schedule[0].caption);
      }
      try { await audio.play(); } catch(e) {}
      if(rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(updateLoop);
    });
    btnVR.addEventListener('click', ()=> { try { scene.enterVR(); } catch(e) {} });
    btnPlay.addEventListener('click', ()=> { if (audio.paused) audio.play(); else audio.pause(); });
    btnPrev.addEventListener('click', ()=> {
      const prev = Math.max(0, idx - 1);
      audio.currentTime = schedule[prev].t + 0.01;
      startFade(prev, true);
    });
    btnNext.addEventListener('click', ()=> {
      const next = Math.min(schedule.length - 1, idx + 1);
      audio.currentTime = schedule[next].t + 0.01;
      startFade(next, true);
    });

    // Reforzar estado al entrar a VR
    scene.addEventListener('enter-vr', ()=>{
      const current = usingA ? skyA : skyB;
      const other   = usingA ? skyB : skyA;
      setOpacity(current,1); setOpacity(other,0);
      forceMatUpdate(current); forceMatUpdate(other);
    });

    // “Responsive” para menú (ajuste de escala/ distancia según aspect ratio)
    function fitMenuToViewport(){
      const root = document.getElementById('menuRoot');
      const ar = window.innerWidth / window.innerHeight;
      if (ar < 1.0) { // vertical/estrecho → acerca y escala un poco
        root.setAttribute('position','0 0 -1.35');
        root.setAttribute('scale','1.12 1.12 1');
      } else {        // horizontal → distancia por defecto
        root.setAttribute('position','0 0 -1.5');
        root.setAttribute('scale','1 1 1');
      }
    }
    window.addEventListener('resize', fitMenuToViewport);
    fitMenuToViewport();
  </script>
</body>
</html>


